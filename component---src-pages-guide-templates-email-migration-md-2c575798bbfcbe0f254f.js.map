{"version":3,"file":"component---src-pages-guide-templates-email-migration-md-2c575798bbfcbe0f254f.js","mappings":"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","sources":["webpack://commerce-frontend-core/./src/pages/guide/templates/email-migration.md"],"sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\n\nimport DefaultLayout from \"/home/runner/work/commerce-frontend-core/commerce-frontend-core/node_modules/@adobe/gatsby-theme-aio/src/components/MDXFilter/index.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst InlineAlert = makeShortcode(\"InlineAlert\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h1 {...{\n      \"id\": \"migrate-custom-email-templates\"\n    }}>{`Migrate custom email templates`}</h1>\n    <p>{`This topic explains how to migrate custom email templates between versions of Adobe Commerce and Magento Open Source.`}</p>\n    <h2 {...{\n      \"id\": \"remove-the-legacy-variable-resolver\"\n    }}>{`Remove the legacy variable resolver`}</h2>\n    <p>{`With the release of Adobe Commerce and Magento Open Source 2.4.4 and 2.4.3-p2, `}<inlineCode parentName=\"p\">{`\\\\Magento\\\\Framework\\\\Filter\\\\VariableResolver\\\\LegacyResolver`}</inlineCode>{` and `}<inlineCode parentName=\"p\">{`\\\\Magento\\\\Framework\\\\Filter\\\\VariableResolver\\\\StrategyResolver`}</inlineCode>{` have been removed and any legacy templates in the database will only be resolved using strict mode. Database templates can be checked using CLI commands to verify\ncompatibility with strict mode.`}</p>\n    <h2 {...{\n      \"id\": \"verify-compatibility-with-strict-mode\"\n    }}>{`Verify compatibility with strict mode`}</h2>\n    <p>{`The following command scans all database email templates overridden using the Admin `}<strong parentName=\"p\">{`Marketing`}</strong>{` > Communications > `}<strong parentName=\"p\">{`Email Templates`}</strong>{` > `}<strong parentName=\"p\">{`Add New Template`}</strong>{` area for potential variable usage compatibility issues.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`bin/magento dev:email:override-compatibility-check\n`}</code></pre>\n    <p>{`To scan email templates overriden using a custom `}<a parentName=\"p\" {...{\n        \"href\": \"https://devdocs.magento.com/guides/v2.4/frontend-dev-guide/templates/template-email.html#customize-email-theme\"\n      }}>{`theme`}</a>{`, please consider using the `}<a parentName=\"p\" {...{\n        \"href\": \"https://experienceleague.adobe.com/docs/commerce-operations/upgrade-guide/upgrade-compatibility-tool/install.html\"\n      }}>{`Upgrade Compatibility Tool`}</a>{`.`}</p>\n    <p>{`The following command scans newsletter templates for any potential variable usage compatibility issues.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`bin/magento dev:email:newsletter-compatibility-check\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"changes-to-the-custom-email-template-workflow\"\n    }}>{`Changes to the custom email template workflow`}</h2>\n    <p>{`As of Adobe Commerce and Magento Open Source 2.3.4, custom email templates are only allowed to use scalar values for variable data.\nDirect calls to methods are no longer allowed.\nTo be more specific, methods can no longer be called from variables from either the `}<inlineCode parentName=\"p\">{`var`}</inlineCode>{` directive or when used as parameters.\nFor example `}<inlineCode parentName=\"p\">{`{{var order.getEmailCustomerNote()}}`}</inlineCode>{` or `}<inlineCode parentName=\"p\">{`{{something myVar=$obj.method()}}`}</inlineCode>{` will fail to resolve.`}</p>\n    <p>{`A 'custom email template' is any new template created in the Admin `}<strong parentName=\"p\">{`Marketing`}</strong>{` > Communications > `}<strong parentName=\"p\">{`Email Templates`}</strong>{` > `}<strong parentName=\"p\">{`Add New Template`}</strong>{` area.\nNotice in the incorrect example, the `}<inlineCode parentName=\"p\">{`getConfirmationLink()`}</inlineCode>{` method is called directly.`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Old way: `}<inlineCode parentName=\"li\">{`{{var subscriber.getConfirmationLink()}}`}</inlineCode></li>\n      <li parentName=\"ul\">{`New way: `}<inlineCode parentName=\"li\">{`{{var subscriber_data.confirmation_link}}`}</inlineCode></li>\n    </ul>\n    <p>{`Note that spaces should be not be used next to the braces:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Correct: `}<inlineCode parentName=\"li\">{`{{var subscriber_data.confirmation_link}}`}</inlineCode></li>\n      <li parentName=\"ul\">{`Incorrect: `}<inlineCode parentName=\"li\">{`{{ var subscriber_data.confirmation_link }}`}</inlineCode></li>\n    </ul>\n    <p>{`We refer to this as 'strict mode' for email templates.\nAll default templates have been converted to this strict mode.`}</p>\n    <InlineAlert variant=\"info\" slots=\"text\" mdxType=\"InlineAlert\" />\n    <p>{`All existing custom email templates will continue to work after upgrading to 2.3.4.\nAny new email template created after installing 2.3.4 must be written in strict mode.\nAs of 2.4.0, the template filter, specifically anything that uses or extends `}<inlineCode parentName=\"p\">{`\\\\Magento\\\\Framework\\\\Filter\\\\Template`}</inlineCode>{`, will use strict mode by default.`}</p>\n    <h2 {...{\n      \"id\": \"abstraction-example\"\n    }}>{`Abstraction example`}</h2>\n    <p>{`Pre-2.3.4, the New Order email template had a line with a direct method call:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-html\"\n      }}>{`<p class=\"greeting\">{{trans \"%customer_name\", customer_name=$order.getCustomerName()}}</p>\n`}</code></pre>\n    <p>{`As of 2.3.4, with the method call removed:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-html\"\n      }}>{`<p class=\"greeting\">{{trans \"%customer_name\", customer_name=$order_data.customer_name}}</p>\n`}</code></pre>\n    <p>{`Below, within the `}<inlineCode parentName=\"p\">{`$transport`}</inlineCode>{` block, `}<inlineCode parentName=\"p\">{`customer_name`}</inlineCode>{` is defined in the `}<inlineCode parentName=\"p\">{`order_data`}</inlineCode>{` object and the method call place there.\nThis `}<inlineCode parentName=\"p\">{`order_data`}</inlineCode>{` object is passed to the view page as a `}<inlineCode parentName=\"p\">{`DataObject`}</inlineCode>{` and is referenced in the variable as above.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`public function send(Invoice $invoice, $forceSyncMode = false)\n{\n    $this->identityContainer->setStore($invoice->getStore());\n    $invoice->setSendEmail($this->identityContainer->isEnabled());\n    if (!$this->globalConfig->getValue('sales_email/general/async_sending') || $forceSyncMode) {\n        $order = $invoice->getOrder();\n        if ($this->checkIfPartialInvoice($order, $invoice)) {\n            $order->setBaseSubtotal((float) $invoice->getBaseSubtotal());\n            $order->setBaseTaxAmount((float) $invoice->getBaseTaxAmount());\n            $order->setBaseShippingAmount((float) $invoice->getBaseShippingAmount());\n        }\n        $transport = [\n            'order' => $order,\n            'order_id' => $order->getId(),\n            'invoice' => $invoice,\n            'invoice_id' => $invoice->getId(),\n            'comment' => $invoice->getCustomerNoteNotify() ? $invoice->getCustomerNote() : '',\n            'billing' => $order->getBillingAddress(),\n            'payment_html' => $this->getPaymentHtml($order),\n            'store' => $order->getStore(),\n            'formattedShippingAddress' => $this->getFormattedShippingAddress($order),\n            'formattedBillingAddress' => $this->getFormattedBillingAddress($order),\n            'order_data' => [\n                'customer_name' => $order->getCustomerName(),\n                'is_not_virtual' => $order->getIsNotVirtual(),\n                'email_customer_note' => $order->getEmailCustomerNote(),\n                'frontend_status_label' => $order->getFrontendStatusLabel()\n            ]\n        ];\n        $transportObject = new DataObject($transport);\n`}</code></pre>\n    <p>{`In this example, the `}<inlineCode parentName=\"p\">{`customer.name`}</inlineCode>{` is being computed within the `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/magento/magento2/blob/2.4/app/code/Magento/Sales/Model/Order/Email/Sender/InvoiceSender.php\"\n      }}>{`model`}</a>{` file.\nDepending on the particular instance, this data point can be appended within a custom module, directive or any manner of ways.`}</p>\n    <h2 {...{\n      \"id\": \"create-a-custom-directive\"\n    }}>{`Create a custom directive`}</h2>\n    <p>{`The above examples show changes to default application files. We do not recommend editing core files as changes may be lost when upgrading.\nInstead, if you need to call a method for a custom email template variable, create a custom directive.\nIn this example, we will create and pass a `}<inlineCode parentName=\"p\">{`lifetime_spend`}</inlineCode>{` custom value.`}</p>\n    <ol>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Create a class that implements `}<inlineCode parentName=\"p\">{`Magento\\\\Framework\\\\Filter\\\\SimpleDirective\\\\ProcessorInterface`}</inlineCode>{`:`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-php\"\n          }}>{` declare(strict_types=1);\n namespace GadgetCorp\\\\CustomEmailDirective\\\\Model;\n use Magento\\\\Framework\\\\Filter\\\\SimpleDirective\\\\ProcessorInterface;\n use Magento\\\\Framework\\\\Pricing\\\\PriceCurrencyInterface;\n /**\n * Calculates the lifetime spend of all customers\n */\n class LifetimeSpendDirective implements ProcessorInterface\n {\n     /**\n     * @var PriceCurrencyInterface\n     */\n     private $priceCurrency;\n     /**\n     * @param PriceCurrencyInterface $priceCurrency\n     */\n     public function __construct(PriceCurrencyInterface $priceCurrency)\n     {\n         $this->priceCurrency = $priceCurrency;\n     }\n     /**\n     * @inheritDoc\n     */\n     public function getName(): string\n     {\n         return 'lifetime_spend';\n     }\n     /**\n     * @inheritDoc\n     */\n     public function process($value, array $parameters, ?string $html): string\n     {\n         $shouldBold = !empty($parameters['should_bold']);\n         $amount = $this->priceCurrency->getCurrencySymbol() . $this->calculateLifetimeSpend();\n         return ($shouldBold ? '<strong>' . $amount . '</strong>' : $amount);\n     }\n     /**\n     * @inheritDoc\n     */\n     public function getDefaultFilters(): ?array\n     {\n         // Make sure newlines are converted to <br /> tags by default\n         return ['nl2br'];\n     }\n     /**\n     * Calculate the total amount of money spent by all customers for all time\n     *\n     * @return float\n     */\n     private function calculateLifetimeSpend(): float\n     {\n         // Add code here to calculate the lifetime spend\n         return 123.45;\n     }\n }\n`}</code></pre>\n        <p parentName=\"li\">{`and save the file to `}<inlineCode parentName=\"p\">{`<Vendor>/<module>/Model`}</inlineCode>{`.`}</p>\n      </li>\n      <li parentName=\"ol\">\n        <p parentName=\"li\">{`Add the new directive to the pool by adding this block to `}<inlineCode parentName=\"p\">{`di.xml`}</inlineCode>{`.`}</p>\n        <pre parentName=\"li\"><code parentName=\"pre\" {...{\n            \"className\": \"language-xml\"\n          }}>{`<config xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:noNamespaceSchemaLocation=\"urn:magento:framework:ObjectManager/etc/config.xsd\">\n <type name=\"Magento\\\\Framework\\\\Filter\\\\SimpleDirective\\\\ProcessorPool\">\n     <arguments>\n         <argument name=\"processors\" xsi:type=\"array\">\n             <item name=\"lifetime_spend\" xsi:type=\"object\">GadgetCorp\\\\CustomEmailDirective\\\\Model\\\\LifetimeSpendDirective</item>\n         </argument>\n     </arguments>\n </type>\n</config>\n`}</code></pre>\n      </li>\n    </ol>\n    <p>{`The new variable is now available within the email template as `}<inlineCode parentName=\"p\">{`{{lifetime_spend}}`}</inlineCode>{`.\nNote in the class above, we also defined the parameter `}<inlineCode parentName=\"p\">{`shouldBold`}</inlineCode>{`. We can use that with `}<inlineCode parentName=\"p\">{`{{lifetime_spend should_bold=1}}`}</inlineCode>{`.\nYou may also use multiple filters within a var statement: `}<inlineCode parentName=\"p\">{`{{lifetime_spend should_bold=1 |escape|nl2br}}`}</inlineCode>{`.`}</p>\n    <h2 {...{\n      \"id\": \"data-objects-and-geturl\"\n    }}>{`Data objects and getUrl`}</h2>\n    <p>{`There are a couple of exceptions to strict mode.`}</p>\n    <p>{`One exception is for objects that extend from `}<inlineCode parentName=\"p\">{`DataObject`}</inlineCode>{`. These can still be called directly.\nEven then, we do not actually call the getter method directly, but rather, resolve which key is needed and call `}<inlineCode parentName=\"p\">{`getData(<keyname>)`}</inlineCode>{` instead.`}</p>\n    <p>{`For example, if we have:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`$template->setVariables(['customer_data'=>new DataObject('my_key' => 'foo')]);\n`}</code></pre>\n    <p>{`and in the template where we have`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`{{somedir mydir mydir=$customer_data.getMyKey()}}\n`}</code></pre>\n    <p>{`the directive will resolve to “foo”.`}</p>\n    <p>{`The same is true for `}<inlineCode parentName=\"p\">{`{{directive foo foo=$customer_data.my_key()}}`}</inlineCode>{`.\nBut note that in both cases the DataObject will not have `}<inlineCode parentName=\"p\">{`getMyKey`}</inlineCode>{` invoked but rather `}<inlineCode parentName=\"p\">{`getData(‘my_key’)`}</inlineCode>{` is invoked instead.`}</p>\n    <p>{`The second exception is for `}<inlineCode parentName=\"p\">{`getUrl`}</inlineCode>{`.\nDirectives that use the format `}<inlineCode parentName=\"p\">{`{{var this.getUrl(params)}}`}</inlineCode>{` will still continue to work for now.`}</p>\n    <h2 {...{\n      \"id\": \"advanced-filtering\"\n    }}>{`Advanced filtering`}</h2>\n    <p>{`As part of this change, we have removed the limit of processing 2 filters per directive.\nNow `}<inlineCode parentName=\"p\">{`{{var order_data.shipping_description|filter1|filter2|filter3}}`}</inlineCode>{` will work.`}</p>\n    <h2 {...{\n      \"id\": \"nested-arrays\"\n    }}>{`Nested arrays`}</h2>\n    <p>{`Getting data from nested arrays is now supported.\nFor example, if we have:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`$template->setVariables(['customer_data'=> ['name' => ['first_name' => 'John']]]);\n`}</code></pre>\n    <p>{`and in the template:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`{{mydir test fname=$customer_data.name.first_name}}\n`}</code></pre>\n    <p>{`it will resolve to “John”.`}</p>\n    <p>{`This new syntax also works in combination with the `}<inlineCode parentName=\"p\">{`DataObject`}</inlineCode>{` exception.\nFor example, if we have:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`$template->setVariables(['customer_data'=> ['name' => new DataObject('first_name' => 'John')]]);\n`}</code></pre>\n    <p>{`and in the template we have:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`{{mydir dir fname=$customer_data.name.first_name}}\n`}</code></pre>\n    <p>{`it will resolve to “John”.`}</p>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"names":["name","_frontmatter","InlineAlert","props","console","warn","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","mdxType","parentName","variant","slots","isMDXComponent"],"sourceRoot":""}